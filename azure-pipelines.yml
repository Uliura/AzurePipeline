stages:

  - stage: terraform
    displayName: Build infrastructure
    jobs:
    - job: Terraform_Plan
      displayName: Terraform Init, Plan & Apply
      pool:
        name: My-AKS-Pool
      steps:
       - task: TerraformTaskV2@2
         inputs:
            provider: 'azurerm'
            command: 'init'
            backendServiceArm: 'AzureDevOpsSP'
            backendAzureRmResourceGroupName: 'AzureDevOps'
            backendAzureRmStorageAccountName: 'storadgeforazuredevops'
            backendAzureRmContainerName: 'terrablobs'
            backendAzureRmKey: 'terraform.tfstate'
       - task: TerraformTaskV2@2
         inputs:
           provider: 'azurerm'
           command: 'plan'
           commandOptions: '-out=tfplan'
           environmentServiceNameAzureRM: 'AzureDevOpsSP'
       - task: TerraformTaskV2@2
         inputs:
            provider: 'azurerm'
            command: 'apply'
            commandOptions: 'tfplan'
            environmentServiceNameAzureRM: 'AzureDevOpsSP'
            
  - stage: BuildApp
    displayName: Build webapp
    jobs:
    - job: buildapp
      displayName: build app
      pool:
        name: Azure Pipelines
        vmImage: 'windows-2019' 
        demands:
         - msbuild
         - visualstudio
          
          #Your build pipeline references an undefined variable named ‘Parameters.solution’. Create or edit the build pipeline for this YAML file, define the variable on the Variables tab. See https://go.microsoft.com/fwlink/?linkid=865972
          #Your build pipeline references an undefined variable named ‘Parameters.solution’. Create or edit the build pipeline for this YAML file, define the variable on the Variables tab. See https://go.microsoft.com/fwlink/?linkid=865972
          #Your build pipeline references the ‘BuildPlatform’ variable, which you’ve selected to be settable at queue time. Create or edit the build pipeline for this YAML file, define the variable on the Variables tab, and then select the option to make it settable at queue time. See https://go.microsoft.com/fwlink/?linkid=865971
          #Your build pipeline references the ‘BuildConfiguration’ variable, which you’ve selected to be settable at queue time. Create or edit the build pipeline for this YAML file, define the variable on the Variables tab, and then select the option to make it settable at queue time. See https://go.microsoft.com/fwlink/?linkid=865971
          #Your build pipeline references an undefined variable named ‘Parameters.ArtifactName’. Create or edit the build pipeline for this YAML file, define the variable on the Variables tab. See https://go.microsoft.com/fwlink/?linkid=865972
          
      steps:
        - task: NuGetToolInstaller@1
          displayName: 'Use NuGet 5.8.0'
          inputs:
            versionSpec: 5.8.0
          
        - task: NuGetCommand@2
          displayName: 'NuGet restore'
          inputs:
            restoreSolution: '$(Parameters.solution)'
          
        - task: VSBuild@1
          displayName: 'Build solution'
          inputs:
            solution: '$(Parameters.solution)'
            msbuildArgs: '/p:DeployOnBuild=true /p:WebPublishMethod=Package /p:PackageAsSingleFile=true /p:SkipInvalidConfigurations=true /p:PackageLocation="$(build.artifactstagingdirectory)\\"'
            platform: 'any cpu'
            configuration: 'release'
          
        - task: PublishSymbols@1
          displayName: 'Publish symbols path'
          inputs:
            SearchPattern: '**\bin\**\*.pdb'
          continueOnError: true
          
        - task: CopyFiles@2
          displayName: 'Copy Database File'
          inputs:
            Contents: '**\*.dacpac'
            TargetFolder: '$(build.artifactstagingdirectory)'
            flattenFolders: true
          
        - task: PublishBuildArtifacts@1
          displayName: 'Publish Artifact'
          inputs:
            PathtoPublish: '$(build.artifactstagingdirectory)'
            ArtifactName: '$(Parameters.ArtifactName)'
          
  - stage: DeployApp
    displayName: Deploy app
    jobs:
    - job: Deployapp
      displayName: Deploy app
      pool:
        vmImage: 'windows-2019' 
      steps:
        - task: AzureRmWebAppDeployment@3
          displayName: 'Deploy Azure App Service'
          inputs:
             environmentServiceNameAzureRM: 'AzureDevOpsSP'
             WebAppName: cicdtestwinapp
             Package: '$(System.DefaultWorkingDirectory)\**\*.zip'
             WebAppUri: webAppUrl
             TakeAppOfflineFlag: true
             UseWebDeploy: true
             RenameFilesFlag: true
             enableXmlVariableSubstitution: true
      